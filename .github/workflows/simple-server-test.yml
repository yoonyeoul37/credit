name: Simple Server Test

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Create simple test package
        run: |
          echo "ğŸ“¦ ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ íŒ¨í‚¤ì§€ ìƒì„±..."
          tar -czf simple-test.tar.gz simple-server-test.js package.json package-lock.json
          ls -la simple-test.tar.gz
          
      - name: Upload test package
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.CAFE24_HOST }}
          username: ${{ secrets.CAFE24_USERNAME }}
          password: ${{ secrets.CAFE24_PASSWORD }}
          port: ${{ secrets.CAFE24_PORT }}
          source: "simple-test.tar.gz"
          target: "/tmp/"
          
      - name: Run simple server test
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.CAFE24_HOST }}
          username: ${{ secrets.CAFE24_USERNAME }}
          password: ${{ secrets.CAFE24_PASSWORD }}
          port: ${{ secrets.CAFE24_PORT }}
          timeout: 300s
          script: |
            echo "ğŸ§ª ê°„ë‹¨í•œ ì„œë²„ í…ŒìŠ¤íŠ¸ ì‹œì‘..."
            
            # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
            echo "ğŸ›‘ ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬..."
            pkill -f "node" || echo "Node.js í”„ë¡œì„¸ìŠ¤ ì—†ìŒ"
            pkill -f "npm" || echo "npm í”„ë¡œì„¸ìŠ¤ ì—†ìŒ"
            
            # í…ŒìŠ¤íŠ¸ ë””ë ‰í† ë¦¬ ìƒì„±
            echo "ğŸ“ í…ŒìŠ¤íŠ¸ ë””ë ‰í† ë¦¬ ìƒì„±..."
            TEST_DIR="$HOME/simple-test"
            mkdir -p "$TEST_DIR"
            cd "$TEST_DIR"
            
            # íŒŒì¼ ì••ì¶• í•´ì œ
            echo "ğŸ“¦ íŒŒì¼ ì••ì¶• í•´ì œ..."
            tar -xzf /tmp/simple-test.tar.gz
            ls -la
            
            # ì‹œìŠ¤í…œ ì •ë³´ í™•ì¸
            echo "ğŸ” ì‹œìŠ¤í…œ ì •ë³´..."
            echo "Node.js ë²„ì „: $(node --version)"
            echo "npm ë²„ì „: $(npm --version)"
            echo "í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"
            
            # Express ì„¤ì¹˜
            echo "ğŸ“‹ Express ì„¤ì¹˜..."
            npm install express --silent
            
            # ì„œë²„ ì‹œì‘ í•¨ìˆ˜
            test_simple_server() {
              local port=$1
              echo "ğŸš€ í¬íŠ¸ $portì—ì„œ ê°„ë‹¨í•œ ì„œë²„ ì‹œì‘..."
              
              # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
              export NODE_ENV=production
              export PORT=$port
              
              # ì„œë²„ ì‹œì‘
              nohup node simple-server-test.js > /tmp/simple-server-$port.log 2>&1 &
              SERVER_PID=$!
              echo "ì„œë²„ PID: $SERVER_PID"
              
              # ì„œë²„ ì‹œì‘ ëŒ€ê¸°
              sleep 8
              
              # ì„œë²„ í™•ì¸
              echo "ğŸ” ì„œë²„ í™•ì¸ ì¤‘..."
              for i in {1..10}; do
                echo "  ì‹œë„ $i/10..."
                
                # í¬íŠ¸ í™•ì¸
                if netstat -an | grep ":$port" | grep -q "LISTEN"; then
                  echo "âœ… í¬íŠ¸ $port LISTEN ìƒíƒœ í™•ì¸!"
                  
                  # HTTP ì‘ë‹µ í™•ì¸
                  HTTP_RESPONSE=$(curl -s -w "%{http_code}" -o /dev/null --max-time 10 http://localhost:$port 2>&1)
                  echo "HTTP ì‘ë‹µ ì½”ë“œ: $HTTP_RESPONSE"
                  
                  if [ "$HTTP_RESPONSE" = "200" ]; then
                    echo "âœ… ê°„ë‹¨í•œ ì„œë²„ í…ŒìŠ¤íŠ¸ ì„±ê³µ!"
                    echo "ğŸŒ ì„œë²„ ì‘ë‹µ:"
                    curl -s http://localhost:$port | head -10
                    echo "ğŸ“Š ì„œë²„ ìƒíƒœ ì •ë³´:"
                    curl -s http://localhost:$port/status
                    return 0
                  else
                    echo "âš ï¸ HTTP ì‘ë‹µ ì½”ë“œ ë¹„ì •ìƒ: $HTTP_RESPONSE"
                    echo "ğŸ“ ì„œë²„ ë¡œê·¸:"
                    cat /tmp/simple-server-$port.log
                  fi
                else
                  echo "âš ï¸ í¬íŠ¸ $port ì•„ì§ LISTEN ì•ˆë¨"
                fi
                
                sleep 3
              done
              
              echo "âŒ ê°„ë‹¨í•œ ì„œë²„ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
              echo "ğŸ“ ìµœì¢… ë¡œê·¸:"
              cat /tmp/simple-server-$port.log
              kill $SERVER_PID 2>/dev/null || true
              return 1
            }
            
            # í¬íŠ¸ 3000ë¶€í„° í…ŒìŠ¤íŠ¸
            if test_simple_server 3000; then
              echo "ğŸ‰ í¬íŠ¸ 3000ì—ì„œ ê°„ë‹¨í•œ ì„œë²„ í…ŒìŠ¤íŠ¸ ì„±ê³µ!"
            elif test_simple_server 8080; then
              echo "ğŸ‰ í¬íŠ¸ 8080ì—ì„œ ê°„ë‹¨í•œ ì„œë²„ í…ŒìŠ¤íŠ¸ ì„±ê³µ!"
            elif test_simple_server 8081; then
              echo "ğŸ‰ í¬íŠ¸ 8081ì—ì„œ ê°„ë‹¨í•œ ì„œë²„ í…ŒìŠ¤íŠ¸ ì„±ê³µ!"
            else
              echo "âŒ ëª¨ë“  í¬íŠ¸ì—ì„œ ê°„ë‹¨í•œ ì„œë²„ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
              echo "ğŸ“ ì‹œìŠ¤í…œ ìƒíƒœ:"
              ps aux | grep -E "(node|npm)" | head -10
              netstat -tulpn | grep -E "(3000|8080|8081)"
              exit 1
            fi
            
            echo "ğŸ‰ ê°„ë‹¨í•œ ì„œë²„ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!"
            echo "âœ… ì¹´í˜24 ì„œë²„ì—ì„œ Node.js ì •ìƒ ë™ì‘ í™•ì¸!"
            
            # ì •ë¦¬
            rm -f /tmp/simple-test.tar.gz 