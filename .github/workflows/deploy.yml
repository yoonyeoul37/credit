name: Deploy to Cafe24

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to Cafe24 Server
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.CAFE24_HOST }}
        username: ${{ secrets.CAFE24_USERNAME }}
        password: ${{ secrets.CAFE24_PASSWORD }}
        port: ${{ secrets.CAFE24_PORT }}
        script: |
          cd /home/hosting_users/${{ secrets.CAFE24_USERNAME }}/www
          echo "ğŸš€ í¬ë ˆë”§ìŠ¤í† ë¦¬ ë°°í¬ ì‹œì‘..."
          
          # ëª¨ë“  í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
          echo "ğŸ”„ ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬..."
          pkill -f "node" 2>/dev/null || true
          pkill -f "next" 2>/dev/null || true
          pkill -f "npm" 2>/dev/null || true
          pm2 kill 2>/dev/null || true
          
          # Docker í”„ë¡œì„¸ìŠ¤ë„ ì •ë¦¬ (í˜¹ì‹œ ëª¨ë¥´ë‹ˆ)
          docker stop $(docker ps -q) 2>/dev/null || true
          docker rm $(docker ps -aq) 2>/dev/null || true
          
          # ìµœì‹  ì½”ë“œ ì—…ë°ì´íŠ¸
          echo "ğŸ“¥ ì½”ë“œ ì—…ë°ì´íŠ¸..."
          git pull origin main
          
          # Node.js ì˜ì¡´ì„± ì„¤ì¹˜
          echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜..."
          npm install
          
          # ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
          echo "ğŸ—ï¸ ë¹Œë“œ..."
          npm run build
          
          # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
          echo "ğŸ”§ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •..."
          export NODE_ENV=production
          export PORT=3000
          export HOSTNAME=0.0.0.0
          
          # ì„œë²„ ì‹œì‘
          echo "ğŸš€ ì„œë²„ ì‹œì‘..."
          nohup npm start > app.log 2>&1 &
          
          # ì ì‹œ ëŒ€ê¸° í›„ í™•ì¸
          sleep 5
          
          # í”„ë¡œì„¸ìŠ¤ í™•ì¸
          if pgrep -f "next" > /dev/null; then
            echo "âœ… ë°°í¬ ì„±ê³µ!"
            echo "ğŸ“‹ í”„ë¡œì„¸ìŠ¤ ID: $(pgrep -f "next")"
          else
            echo "âŒ ë°°í¬ ì‹¤íŒ¨. ë¡œê·¸:"
            tail -20 app.log
          fi 