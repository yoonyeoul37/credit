name: Deploy to Cafe24 Static

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build Next.js static site
        run: npm run build
        env:
          NODE_ENV: production
          NEXT_PUBLIC_SUPABASE_URL: https://jwstrrxoyikjyafhaeyo.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3c3RycnhveWlranlhZmhhZXlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIxNTIzMzMsImV4cCI6MjA2NzcyODMzM30.ZpfX0zp5pJ_pstXjRkYNg85FoFEIP4qV3Js4nhTeFDU
          
      - name: Create deployment package
        run: |
          echo "ğŸ“¦ ì •ì  ì‚¬ì´íŠ¸ íŒ¨í‚¤ì§€ ìƒì„± ì¤‘..."
          tar -czf static-site.tar.gz out/
          ls -la static-site.tar.gz
          ls -la out/
          
      - name: Upload static site to server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.CAFE24_HOST }}
          username: ${{ secrets.CAFE24_USERNAME }}
          password: ${{ secrets.CAFE24_PASSWORD }}
          port: ${{ secrets.CAFE24_PORT }}
          source: "static-site.tar.gz"
          target: "/tmp/"
          
      - name: Deploy static site
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.CAFE24_HOST }}
          username: ${{ secrets.CAFE24_USERNAME }}
          password: ${{ secrets.CAFE24_PASSWORD }}
          port: ${{ secrets.CAFE24_PORT }}
          timeout: 300s
          script: |
            echo "ğŸš€ ì •ì  ì‚¬ì´íŠ¸ ë°°í¬ ì‹œì‘..."
            
            # ì‹œìŠ¤í…œ ì •ë³´ í™•ì¸
            echo "ğŸ“Š ì‹œìŠ¤í…œ ì •ë³´:"
            whoami
            pwd
            echo "í™ˆ ë””ë ‰í† ë¦¬: $HOME"
            
            # ì›¹ ë£¨íŠ¸ ë””ë ‰í† ë¦¬ ì°¾ê¸°
            if [ -d "$HOME/public_html" ]; then
              WEB_ROOT="$HOME/public_html"
            elif [ -d "$HOME/www" ]; then
              WEB_ROOT="$HOME/www"
            elif [ -d "$HOME/htdocs" ]; then
              WEB_ROOT="$HOME/htdocs"
            else
              WEB_ROOT="$HOME/public_html"
              mkdir -p "$WEB_ROOT"
            fi
            
            echo "ì›¹ ë£¨íŠ¸ ë””ë ‰í† ë¦¬: $WEB_ROOT"
            
            # ê¸°ì¡´ íŒŒì¼ ë°±ì—…
            if [ -f "$WEB_ROOT/index.html" ]; then
              echo "ğŸ”„ ê¸°ì¡´ ì‚¬ì´íŠ¸ ë°±ì—…..."
              mv "$WEB_ROOT" "$WEB_ROOT.backup.$(date +%Y%m%d_%H%M%S)" || true
              mkdir -p "$WEB_ROOT"
            fi
            
            # ì •ì  ì‚¬ì´íŠ¸ ì••ì¶• í•´ì œ
            echo "ğŸ“¦ ì •ì  ì‚¬ì´íŠ¸ ì„¤ì¹˜ ì¤‘..."
            cd /tmp
            tar -xzf static-site.tar.gz
            
            # íŒŒì¼ ë³µì‚¬
            echo "ğŸ“ íŒŒì¼ ë³µì‚¬ ì¤‘..."
            cp -r out/* "$WEB_ROOT/"
            
            # ê¶Œí•œ ì„¤ì •
            chmod -R 755 "$WEB_ROOT"
            
            # ê²°ê³¼ í™•ì¸
            echo "âœ… ë°°í¬ ì™„ë£Œ!"
            echo "ğŸ“ ì›¹ ë£¨íŠ¸: $WEB_ROOT"
            echo "ğŸ“„ íŒŒì¼ ëª©ë¡:"
            ls -la "$WEB_ROOT"
            echo "ğŸŒ ì ‘ì† ì£¼ì†Œ: http://ë„ë©”ì¸/"
            echo "ğŸ‰ ì •ì  ì‚¬ì´íŠ¸ ë°°í¬ ì„±ê³µ! Node.js ì„œë²„ ì—†ì´ ë°”ë¡œ ì ‘ì† ê°€ëŠ¥í•©ë‹ˆë‹¤."
            
            # ì •ë¦¬
            rm -f /tmp/static-site.tar.gz
            rm -rf /tmp/out
