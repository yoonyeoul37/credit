name: Deploy to Cafe24

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build Next.js
        run: npm run build
        env:
          NODE_ENV: production
          NEXT_PUBLIC_SUPABASE_URL: https://jwstrrxoyikjyafhaeyo.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3c3RycnhveWlranlhZmhhZXlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIxNTIzMzMsImV4cCI6MjA2NzcyODMzM30.ZpfX0zp5pJ_pstXjRkYNg85FoFEIP4qV3Js4nhTeFDU
          
      - name: Create deployment package
        run: |
          echo "ğŸ“¦ ë°°í¬ íŒ¨í‚¤ì§€ ìƒì„± ì¤‘..."
          tar -czf deploy.tar.gz .next package.json package-lock.json public next.config.ts
          ls -la deploy.tar.gz
          
      - name: Upload deployment package
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.CAFE24_HOST }}
          username: ${{ secrets.CAFE24_USERNAME }}
          password: ${{ secrets.CAFE24_PASSWORD }}
          port: ${{ secrets.CAFE24_PORT }}
          source: "deploy.tar.gz"
          target: "/tmp/"
          
      - name: Deploy on server
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.CAFE24_HOST }}
          username: ${{ secrets.CAFE24_USERNAME }}
          password: ${{ secrets.CAFE24_PASSWORD }}
          port: ${{ secrets.CAFE24_PORT }}
          timeout: 300s
          script: |
            echo "ğŸš€ ë°°í¬ ì‹œì‘..."
            
            # ì‹œìŠ¤í…œ ì •ë³´ í™•ì¸
            echo "ğŸ“Š ì‹œìŠ¤í…œ ì •ë³´:"
            node --version || echo "Node.js ì—†ìŒ"
            npm --version || echo "npm ì—†ìŒ"
            whoami
            pwd
            
            # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
            echo "ğŸ”„ ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬..."
            pkill -f "node.*3000" || echo "ê¸°ì¡´ node í”„ë¡œì„¸ìŠ¤ ì—†ìŒ"
            pkill -f "npm.*start" || echo "ê¸°ì¡´ npm í”„ë¡œì„¸ìŠ¤ ì—†ìŒ"
            
            # ë°°í¬ ë””ë ‰í† ë¦¬ ì¤€ë¹„
            echo "ğŸ“ ë°°í¬ ë””ë ‰í† ë¦¬ ì¤€ë¹„..."
            mkdir -p /home/${{ secrets.CAFE24_USERNAME }}/credit-app
            cd /home/${{ secrets.CAFE24_USERNAME }}/credit-app
            echo "í˜„ì¬ ìœ„ì¹˜: $(pwd)"
            
            # ê¸°ì¡´ íŒŒì¼ ë°±ì—…
            if [ -d ".next" ]; then
              echo "ğŸ”„ ê¸°ì¡´ íŒŒì¼ ë°±ì—…..."
              mv .next .next.backup.$(date +%Y%m%d_%H%M%S) || true
            fi
            
            # ìƒˆ íŒŒì¼ ì••ì¶• í•´ì œ
            echo "ğŸ“¦ ìƒˆ ë²„ì „ ì„¤ì¹˜ ì¤‘..."
            tar -xzf /tmp/deploy.tar.gz
            echo "ì••ì¶• í•´ì œ ì™„ë£Œ. íŒŒì¼ ëª©ë¡:"
            ls -la
            
            # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
            echo "ğŸ”§ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •..."
            cat > .env.local << 'EOF'
            NODE_ENV=production
            PORT=3000
            HOSTNAME=0.0.0.0
            NEXT_PUBLIC_SUPABASE_URL=https://jwstrrxoyikjyafhaeyo.supabase.co
            NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3c3RycnhveWlranlhZmhhZXlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIxNTIzMzMsImV4cCI6MjA2NzcyODMzM30.ZpfX0zp5pJ_pstXjRkYNg85FoFEIP4qV3Js4nhTeFDU
            EOF
            echo "í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„± ì™„ë£Œ"
            
            # ì˜ì¡´ì„± ì„¤ì¹˜
            echo "ğŸ“‹ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
            npm ci --production --silent
            echo "ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ"
            
            # package.json í™•ì¸
            echo "ğŸ“„ package.json í™•ì¸:"
            cat package.json | grep -A 5 "scripts"
            
            # ì„œë²„ ì‹œì‘ ì „ í…ŒìŠ¤íŠ¸
            echo "ğŸ§ª ì„œë²„ ì‹œì‘ ì „ í…ŒìŠ¤íŠ¸..."
            npm list --depth=0 || echo "ì˜ì¡´ì„± ëª©ë¡ ì¶œë ¥ ì‹¤íŒ¨"
            
            # ì„œë²„ ì‹œì‘
            echo "ğŸ¯ ì„œë²„ ì‹œì‘ ì¤‘..."
            echo "ëª…ë ¹: npm start"
            nohup npm start > /tmp/credit-app.log 2>&1 &
            SERVER_PID=$!
            echo "ì„œë²„ PID: $SERVER_PID"
            
            # ì„œë²„ ë¡œê·¸ ì´ˆê¸° í™•ì¸
            echo "ğŸ“ ì„œë²„ ì‹œì‘ ë¡œê·¸ (5ì´ˆ í›„):"
            sleep 5
            tail -10 /tmp/credit-app.log
            
            # ì„œë²„ í”„ë¡œì„¸ìŠ¤ í™•ì¸
            echo "ğŸ” ì„œë²„ í”„ë¡œì„¸ìŠ¤ í™•ì¸..."
            ps aux | grep node || echo "node í”„ë¡œì„¸ìŠ¤ ì—†ìŒ"
            
            # í¬íŠ¸ í™•ì¸
            echo "ğŸŒ í¬íŠ¸ 3000 í™•ì¸..."
            netstat -tln | grep 3000 || echo "í¬íŠ¸ 3000 ì‚¬ìš© ì¤‘ ì•„ë‹˜"
            
            # ìµœì¢… í™•ì¸
            sleep 5
            if pgrep -f "node.*3000" > /dev/null || pgrep -f "npm.*start" > /dev/null; then
              echo "âœ… ë°°í¬ ì„±ê³µ!"
              echo "ğŸŒ ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤."
              echo "ğŸ“ ìµœì¢… ë¡œê·¸:"
              tail -5 /tmp/credit-app.log
            else
              echo "âŒ ì„œë²„ ì‹œì‘ ì‹¤íŒ¨"
              echo "ğŸ“ ì „ì²´ ë¡œê·¸:"
              cat /tmp/credit-app.log
              echo "ğŸ” ë””ë²„ê¹… ì •ë³´:"
              echo "í˜„ì¬ í”„ë¡œì„¸ìŠ¤:"
              ps aux | grep -E "(node|npm)"
              echo "í¬íŠ¸ ìƒíƒœ:"
              netstat -tln | grep 3000
              exit 1
            fi
            
            # ì„ì‹œ íŒŒì¼ ì •ë¦¬
            rm -f /tmp/deploy.tar.gz
            echo "ğŸ‰ ë°°í¬ ì™„ë£Œ!"
