name: 카페24 자동 배포

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: 코드 체크아웃
      uses: actions/checkout@v4
      
    - name: Node.js 설정
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: 의존성 설치
      run: npm ci
      
    - name: 프로덕션 빌드
      run: npm run build
      env:
        NODE_ENV: production
        NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
        NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
        
    - name: 배포 패키지 생성
      run: |
        tar -czf deploy.tar.gz .next package.json package-lock.json public next.config.ts src tsconfig.json
        
    - name: 서버에 파일 업로드
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.CAFE24_HOST }}
        username: ${{ secrets.CAFE24_USERNAME }}
        password: ${{ secrets.CAFE24_PASSWORD }}
        port: ${{ secrets.CAFE24_PORT }}
        source: "deploy.tar.gz"
        target: "/tmp/"
        
    - name: 서버에서 배포 실행
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.CAFE24_HOST }}
        username: ${{ secrets.CAFE24_USERNAME }}
        password: ${{ secrets.CAFE24_PASSWORD }}
        port: ${{ secrets.CAFE24_PORT }}
        script: |
          echo "🚀 카페24 자동 배포 시작..."
          
          # 기존 프로세스 정리
          sudo pkill -9 -f "node" || true
          sudo pkill -9 -f "next" || true
          
          # 배포 디렉토리 준비
          cd /var/www/html
          sudo rm -rf nextjs-app
          sudo mkdir -p nextjs-app
          cd nextjs-app
          
          # 파일 압축 해제
          sudo tar -xzf /tmp/deploy.tar.gz
          
          # 의존성 설치
          sudo npm install --production
          
          # 환경변수 설정
          sudo tee .env.local > /dev/null <<EOF
          NODE_ENV=production
          PORT=80
          HOSTNAME=0.0.0.0
          NEXT_PUBLIC_SUPABASE_URL=${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          EOF
          
          # 서버 시작
          sudo nohup npm start > ~/credit-app.log 2>&1 &
          
          # 확인
          sleep 5
          ps aux | grep next
          
          echo "✅ 배포 완료!"
