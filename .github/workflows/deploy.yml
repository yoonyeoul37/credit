name: Deploy to Cafe24

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build Next.js
        run: npm run build
        env:
          NODE_ENV: production
          NEXT_PUBLIC_SUPABASE_URL: https://jwstrrxoyikjyafhaeyo.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3c3RycnhveWlranlhZmhhZXlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIxNTIzMzMsImV4cCI6MjA2NzcyODMzM30.ZpfX0zp5pJ_pstXjRkYNg85FoFEIP4qV3Js4nhTeFDU
          
      - name: Create deployment package
        run: |
          echo "ğŸ“¦ ë°°í¬ íŒ¨í‚¤ì§€ ìƒì„± ì¤‘..."
          tar -czf deploy.tar.gz .next package.json package-lock.json public next.config.ts
          ls -la deploy.tar.gz
          
      - name: Upload deployment package
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.CAFE24_HOST }}
          username: ${{ secrets.CAFE24_USERNAME }}
          password: ${{ secrets.CAFE24_PASSWORD }}
          port: ${{ secrets.CAFE24_PORT }}
          source: "deploy.tar.gz"
          target: "/tmp/"
          
      - name: Deploy on server
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.CAFE24_HOST }}
          username: ${{ secrets.CAFE24_USERNAME }}
          password: ${{ secrets.CAFE24_PASSWORD }}
          port: ${{ secrets.CAFE24_PORT }}
          timeout: 300s
          script: |
            echo "ğŸš€ ë°°í¬ ì‹œì‘..."
            
            # ì‹œìŠ¤í…œ ì •ë³´ í™•ì¸
            echo "ğŸ“Š ì‹œìŠ¤í…œ ì •ë³´:"
            node --version || echo "Node.js ì—†ìŒ"
            npm --version || echo "npm ì—†ìŒ"
            echo "í˜„ì¬ ì‚¬ìš©ì: $(whoami)"
            echo "í˜„ì¬ ìœ„ì¹˜: $(pwd)"
            echo "í™ˆ ë””ë ‰í† ë¦¬: $HOME"
            
            # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
            echo "ğŸ”„ ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬..."
            pkill -f "node.*3000" || echo "ê¸°ì¡´ node í”„ë¡œì„¸ìŠ¤ ì—†ìŒ"
            pkill -f "npm.*start" || echo "ê¸°ì¡´ npm í”„ë¡œì„¸ìŠ¤ ì—†ìŒ"
            
            # ë°°í¬ ë””ë ‰í† ë¦¬ ì¤€ë¹„ (ë™ì  ê²½ë¡œ ì‚¬ìš©)
            echo "ğŸ“ ë°°í¬ ë””ë ‰í† ë¦¬ ì¤€ë¹„..."
            DEPLOY_DIR="$HOME/credit-app"
            echo "ë°°í¬ ë””ë ‰í† ë¦¬: $DEPLOY_DIR"
            mkdir -p "$DEPLOY_DIR"
            cd "$DEPLOY_DIR"
            echo "í˜„ì¬ ìœ„ì¹˜: $(pwd)"
            echo "ë””ë ‰í† ë¦¬ ê¶Œí•œ: $(ls -ld .)"
            
            # ê¸°ì¡´ íŒŒì¼ ë°±ì—…
            if [ -d ".next" ]; then
              echo "ğŸ”„ ê¸°ì¡´ íŒŒì¼ ë°±ì—…..."
              mv .next .next.backup.$(date +%Y%m%d_%H%M%S) || true
            fi
            
            # ìƒˆ íŒŒì¼ ì••ì¶• í•´ì œ
            echo "ğŸ“¦ ìƒˆ ë²„ì „ ì„¤ì¹˜ ì¤‘..."
            tar -xzf /tmp/deploy.tar.gz
            echo "ì••ì¶• í•´ì œ ì™„ë£Œ. íŒŒì¼ ëª©ë¡:"
            ls -la
            
            # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
            echo "ğŸ”§ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •..."
            cat > .env.local << 'EOF'
            NODE_ENV=production
            PORT=3000
            HOSTNAME=0.0.0.0
            NEXT_PUBLIC_SUPABASE_URL=https://jwstrrxoyikjyafhaeyo.supabase.co
            NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3c3RycnhveWlranlhZmhhZXlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIxNTIzMzMsImV4cCI6MjA2NzcyODMzM30.ZpfX0zp5pJ_pstXjRkYNg85FoFEIP4qV3Js4nhTeFDU
            EOF
            echo "í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„± ì™„ë£Œ"
            
            # ì˜ì¡´ì„± ì„¤ì¹˜
            echo "ğŸ“‹ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
            npm ci --production --silent
            echo "ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ"
            
            # package.json í™•ì¸
            echo "ğŸ“„ package.json í™•ì¸:"
            cat package.json | grep -A 5 "scripts"
            
            # ì„œë²„ ì‹œì‘ ì „ í…ŒìŠ¤íŠ¸
            echo "ğŸ§ª ì„œë²„ ì‹œì‘ ì „ í…ŒìŠ¤íŠ¸..."
            npm list --depth=0 || echo "ì˜ì¡´ì„± ëª©ë¡ ì¶œë ¥ ì‹¤íŒ¨"
            
            # ì„œë²„ ì‹œì‘ - ê°„ë‹¨í•œ ë°©ë²•
            echo "ğŸ¯ ì„œë²„ ì‹œì‘ ì¤‘..."
            
            # í¬íŠ¸ 3000 ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
            echo "ğŸ” í¬íŠ¸ 3000 ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸..."
            if netstat -tln | grep -q ":3000 "; then
              echo "âŒ í¬íŠ¸ 3000ì´ ì´ë¯¸ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤!"
              echo "ì‚¬ìš© ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤:"
              lsof -i :3000 || netstat -tulpn | grep :3000
              echo "ğŸ”„ í¬íŠ¸ 3000 ì‚¬ìš© í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ì‹œë„..."
              fuser -k 3000/tcp || echo "fuser ëª…ë ¹ ì‹¤íŒ¨"
              sleep 2
            else
              echo "âœ… í¬íŠ¸ 3000 ì‚¬ìš© ê°€ëŠ¥"
            fi
            
            # Node.js ë²„ì „ í˜¸í™˜ì„± í™•ì¸
            echo "ğŸ” Node.js ë²„ì „ í˜¸í™˜ì„± í™•ì¸..."
            NODE_VERSION=$(node --version | cut -d'v' -f2 | cut -d'.' -f1)
            echo "Node.js ì£¼ ë²„ì „: $NODE_VERSION"
            if [ "$NODE_VERSION" -lt 18 ]; then
              echo "âŒ Node.js ë²„ì „ì´ ë„ˆë¬´ ë‚®ìŠµë‹ˆë‹¤! (í˜„ì¬: $NODE_VERSION, í•„ìš”: 18+)"
              echo "ğŸ”„ ëŒ€ì•ˆ: ë” ë‚®ì€ ë²„ì „ í˜¸í™˜ ë°©ì‹ ì‹œë„..."
            else
              echo "âœ… Node.js ë²„ì „ í˜¸í™˜ë¨"
            fi
            
            # ë°©ë²• 1: í‘œì¤€ npm start
            echo "ğŸš€ ë°©ë²• 1: npm start ì‹œë„"
            npm start > /tmp/credit-app.log 2>&1 &
            NPM_PID=$!
            echo "npm start PID: $NPM_PID"
            
            # 3ì´ˆ ëŒ€ê¸° í›„ ìƒíƒœ í™•ì¸
            sleep 3
            if ps -p $NPM_PID > /dev/null 2>&1; then
              echo "âœ… npm start ì„±ê³µ!"
              SERVER_STARTED=true
            else
              echo "âŒ npm start ì‹¤íŒ¨"
              echo "ğŸ“ npm start ë¡œê·¸:"
              cat /tmp/credit-app.log
              
              # ë°©ë²• 2: ì§ì ‘ next start ì‹¤í–‰
              echo "ğŸš€ ë°©ë²• 2: ì§ì ‘ next start ì‹œë„"
              NODE_ENV=production PORT=3000 HOSTNAME=0.0.0.0 ./node_modules/.bin/next start > /tmp/credit-app2.log 2>&1 &
              NEXT_PID=$!
              echo "next start PID: $NEXT_PID"
              
              sleep 3
              if ps -p $NEXT_PID > /dev/null 2>&1; then
                echo "âœ… next start ì„±ê³µ!"
                SERVER_STARTED=true
              else
                echo "âŒ next start ì‹¤íŒ¨"
                echo "ğŸ“ next start ë¡œê·¸:"
                cat /tmp/credit-app2.log
                
                # ë°©ë²• 3: ë” ê°„ë‹¨í•œ ë°©ì‹
                echo "ğŸš€ ë°©ë²• 3: ê°„ë‹¨í•œ HTTP ì„œë²„ ì‹œë„"
                cat > simple-server.js << 'JSEOF'
const http = require('http');
const fs = require('fs');
const path = require('path');

const port = 3000;
const hostname = '0.0.0.0';

const server = http.createServer((req, res) => {
  res.writeHead(200, { 'Content-Type': 'text/html' });
  res.end(`
    <html>
      <body>
        <h1>ğŸ‰ ì¹´í˜24 ë°°í¬ ì„±ê³µ!</h1>
        <p>Next.js ì•±ì´ ì„±ê³µì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤!</p>
        <p>í˜„ì¬ ì‹œê°„: ${new Date().toLocaleString()}</p>
        <p>ì„œë²„ ì •ë³´: Node.js ${process.version}</p>
      </body>
    </html>
  `);
});

server.listen(port, hostname, () => {
  console.log(`ğŸŒ ì„œë²„ê°€ http://${hostname}:${port}ì—ì„œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤`);
});
JSEOF
                
                node simple-server.js > /tmp/credit-app3.log 2>&1 &
                SIMPLE_PID=$!
                echo "ê°„ë‹¨í•œ ì„œë²„ PID: $SIMPLE_PID"
                sleep 3
                
                if ps -p $SIMPLE_PID > /dev/null 2>&1; then
                  echo "âœ… ê°„ë‹¨í•œ ì„œë²„ ì„±ê³µ!"
                  SERVER_STARTED=true
                else
                  echo "âŒ ëª¨ë“  ë°©ë²• ì‹¤íŒ¨"
                  echo "ğŸ“ ê°„ë‹¨í•œ ì„œë²„ ë¡œê·¸:"
                  cat /tmp/credit-app3.log
                  SERVER_STARTED=false
                fi
              fi
            fi
            
            # ì„œë²„ ì‹œì‘ í™•ì¸
            sleep 2
            echo "ğŸ“ ìµœì¢… ì„œë²„ ë¡œê·¸:"
            tail -10 /tmp/credit-app*.log
            
            # ì„œë²„ í”„ë¡œì„¸ìŠ¤ í™•ì¸
            echo "ğŸ” ì„œë²„ í”„ë¡œì„¸ìŠ¤ í™•ì¸..."
            ps aux | grep -E "(node|npm|next)" | grep -v grep || echo "ê´€ë ¨ í”„ë¡œì„¸ìŠ¤ ì—†ìŒ"
            
            # í¬íŠ¸ í™•ì¸
            echo "ğŸŒ í¬íŠ¸ 3000 í™•ì¸..."
            netstat -tln | grep 3000 || echo "í¬íŠ¸ 3000 ì‚¬ìš© ì¤‘ ì•„ë‹˜"
            
            # ìµœì¢… í™•ì¸
            sleep 3
            if [ "$SERVER_STARTED" = true ] || pgrep -f "node.*3000" > /dev/null || pgrep -f "npm.*start" > /dev/null || pgrep -f "next.*start" > /dev/null; then
              echo "âœ… ë°°í¬ ì„±ê³µ!"
              echo "ğŸŒ ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤."
              echo "ğŸ“ ì‹¤í–‰ ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤:"
              ps aux | grep -E "(node|npm|next)" | grep -v grep
              echo "ğŸ“ í¬íŠ¸ 3000 ìƒíƒœ:"
              netstat -tln | grep 3000
              echo "ğŸ“ ìµœì¢… ë¡œê·¸:"
              tail -5 /tmp/credit-app*.log
            else
              echo "âŒ ì„œë²„ ì‹œì‘ ì‹¤íŒ¨"
              echo "ğŸ“ ëª¨ë“  ë¡œê·¸:"
              echo "=== npm start ë¡œê·¸ ==="
              cat /tmp/credit-app.log 2>/dev/null || echo "ë¡œê·¸ ì—†ìŒ"
              echo "=== next start ë¡œê·¸ ==="
              cat /tmp/credit-app2.log 2>/dev/null || echo "ë¡œê·¸ ì—†ìŒ"
              echo "=== ê°„ë‹¨í•œ ì„œë²„ ë¡œê·¸ ==="
              cat /tmp/credit-app3.log 2>/dev/null || echo "ë¡œê·¸ ì—†ìŒ"
              echo "ğŸ” ìµœì¢… ë””ë²„ê¹… ì •ë³´:"
              echo "í˜„ì¬ í”„ë¡œì„¸ìŠ¤:"
              ps aux | grep -E "(node|npm|next)" | grep -v grep
              echo "í¬íŠ¸ ìƒíƒœ:"
              netstat -tln | grep 3000
              echo "ì„œë²„ íŒŒì¼ ìƒíƒœ:"
              ls -la ./node_modules/.bin/next || echo "next ë°”ì´ë„ˆë¦¬ ì—†ìŒ"
              echo "í™˜ê²½ ë³€ìˆ˜:"
              env | grep -E "(NODE|PORT|HOSTNAME)"
              echo "ë””ìŠ¤í¬ ê³µê°„:"
              df -h .
              echo "ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰:"
              free -h
              exit 1
            fi
            
            # ì„ì‹œ íŒŒì¼ ì •ë¦¬
            rm -f /tmp/deploy.tar.gz
            echo "ğŸ‰ ë°°í¬ ì™„ë£Œ!"
