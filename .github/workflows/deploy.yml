name: Deploy to Cafe24

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to Cafe24 Server
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.CAFE24_HOST }}
        username: ${{ secrets.CAFE24_USERNAME }}
        password: ${{ secrets.CAFE24_PASSWORD }}
        port: ${{ secrets.CAFE24_PORT }}
        script: |
          cd /home/hosting_users/${{ secrets.CAFE24_USERNAME }}/www
          echo "ğŸš€ í¬ë ˆë”§ìŠ¤í† ë¦¬ ìˆœìˆ˜ Node.js ë°°í¬ ì‹œì‘..."
          
          # Node.js í”„ë¡œì„¸ìŠ¤ë§Œ ì •ë¦¬ (Docker ëª…ë ¹ì–´ ì™„ì „ ì œê±°)
          echo "ğŸ”„ ê¸°ì¡´ Node.js í”„ë¡œì„¸ìŠ¤ ì •ë¦¬..."
          pkill -f "node" 2>/dev/null || true
          pkill -f "next" 2>/dev/null || true
          pkill -f "npm" 2>/dev/null || true
          pm2 kill 2>/dev/null || true
          
          # ìµœì‹  ì½”ë“œ ì—…ë°ì´íŠ¸
          echo "ğŸ“¥ ì½”ë“œ ì—…ë°ì´íŠ¸..."
          git pull origin main
          
          # Node.js ì˜ì¡´ì„± ì„¤ì¹˜
          echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜..."
          npm ci --production=false
          
          # ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
          echo "ğŸ—ï¸ Next.js ë¹Œë“œ..."
          npm run build
          
          # í™˜ê²½ ë³€ìˆ˜ ê°•ì œ ì„¤ì •
          echo "ğŸ”§ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •..."
          export NODE_ENV=production
          export PORT=3000
          export HOSTNAME=0.0.0.0
          
          # Supabase í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
          export NEXT_PUBLIC_SUPABASE_URL=https://jwstrrxoyikjyafhaeyo.supabase.co
          export NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3c3RycnhveWlranlhZmhhZXlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIxNTIzMzMsImV4cCI6MjA2NzcyODMzM30.ZpfX0zp5pJ_pstXjRkYNg85FoFEIP4qV3Js4nhTeFDU
          
          echo "âœ… í™˜ê²½ ë³€ìˆ˜ ì„¤ì • ì™„ë£Œ:"
          echo "   NODE_ENV: $NODE_ENV"
          echo "   PORT: $PORT"
          echo "   HOSTNAME: $HOSTNAME"
          
          # ìˆœìˆ˜ Node.jsë¡œ ì„œë²„ ì‹œì‘ (Docker ì—†ìŒ)
          echo "ğŸš€ ìˆœìˆ˜ Node.js ì„œë²„ ì‹œì‘..."
          nohup npm start > /tmp/creditstory.log 2>&1 &
          SERVER_PID=$!
          echo $SERVER_PID > /tmp/creditstory.pid
          
          # ì„œë²„ ì‹œì‘ í™•ì¸
          sleep 5
          
          # í”„ë¡œì„¸ìŠ¤ í™•ì¸
          if ps -p $SERVER_PID > /dev/null 2>&1; then
            echo "âœ… ë°°í¬ ì„±ê³µ!"
            echo "ğŸ“‹ ì„œë²„ PID: $SERVER_PID"
            echo "ğŸ“ ë¡œê·¸: tail -f /tmp/creditstory.log"
          else
            echo "âŒ ë°°í¬ ì‹¤íŒ¨. ë¡œê·¸ í™•ì¸:"
            tail -20 /tmp/creditstory.log
            exit 1
          fi 
          
          echo "ï¿½ï¿½ ìˆœìˆ˜ Node.js ë°°í¬ ì™„ë£Œ!" 