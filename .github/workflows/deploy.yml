name: Deploy to Cafe24

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to Cafe24 Server
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.CAFE24_HOST }}
          username: ${{ secrets.CAFE24_USERNAME }}
          password: ${{ secrets.CAFE24_PASSWORD }}
          port: 22
          script: |
            echo "🔍 웹 루트 디렉토리 탐지 중..."
            
            # 가능한 웹 루트 디렉토리들 탐지
            if [ -d "/var/www/html" ]; then
              WEB_ROOT="/var/www/html"
              echo "✅ 웹 루트 발견: /var/www/html"
            elif [ -d "/home/${{ secrets.CAFE24_USERNAME }}/www" ]; then
              WEB_ROOT="/home/${{ secrets.CAFE24_USERNAME }}/www"
              echo "✅ 웹 루트 발견: /home/${{ secrets.CAFE24_USERNAME }}/www"
            elif [ -d "/home/hosting_users/${{ secrets.CAFE24_USERNAME }}/www" ]; then
              WEB_ROOT="/home/hosting_users/${{ secrets.CAFE24_USERNAME }}/www"
              echo "✅ 웹 루트 발견: /home/hosting_users/${{ secrets.CAFE24_USERNAME }}/www"
            elif [ -d "/srv/www" ]; then
              WEB_ROOT="/srv/www"
              echo "✅ 웹 루트 발견: /srv/www"
            else
              echo "❌ 웹 루트 디렉토리를 찾을 수 없습니다."
              echo "현재 위치: $(pwd)"
              echo "디렉토리 목록:"
              ls -la
              exit 1
            fi
            
            cd $WEB_ROOT
            echo "🚀 크레딧스토리 순수 Node.js 배포 시작..."
            echo "📂 작업 디렉토리: $(pwd)"

            # Node.js 프로세스만 정리 (Docker 명령어 완전 제거)
            echo "🔄 기존 Node.js 프로세스 정리..."
            pkill -f "node" 2>/dev/null || true
            pkill -f "next" 2>/dev/null || true
            pkill -f "npm" 2>/dev/null || true
            pm2 kill 2>/dev/null || true

            # 기존 파일 완전 삭제 및 새 프로젝트 클론
            echo "🗑️ 기존 파일 완전 삭제..."
            rm -rf .git
            rm -rf *
            rm -rf .[^.]*
            
            echo "📥 새 프로젝트 클론..."
            git clone https://github.com/yoonyeoul37/credit-recovery-community.git .
            
            echo "✅ 프로젝트 클론 완료"

            # Node.js 의존성 설치
            echo "📦 의존성 설치..."
            npm ci --production=false

            # 애플리케이션 빌드
            echo "🏗️ Next.js 빌드..."
            npm run build

            # 환경 변수 강제 설정
            echo "🔧 환경 변수 설정..."
            export NODE_ENV=production
            export PORT=3000
            export HOSTNAME=0.0.0.0

            # Supabase 환경 변수 설정
            export NEXT_PUBLIC_SUPABASE_URL=https://jwstrrxoyikjyafhaeyo.supabase.co
            export NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3c3RycnhveWlranlhZmhhZXlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIxNTIzMzMsImV4cCI6MjA2NzcyODMzM30.ZpfX0zp5pJ_pstXjRkYNg85FoFEIP4qV3Js4nhTeFDU

            echo "✅ 환경 변수 설정 완료:"
            echo "   NODE_ENV: $NODE_ENV"
            echo "   PORT: $PORT"
            echo "   HOSTNAME: $HOSTNAME"

            # 순수 Node.js로 서버 시작 (Docker 없음)
            echo "🚀 순수 Node.js 서버 시작..."
            nohup npm start > /tmp/creditstory.log 2>&1 &
            SERVER_PID=$!
            echo $SERVER_PID > /tmp/creditstory.pid

            # 서버 시작 확인
            sleep 5

            # 프로세스 확인
            if ps -p $SERVER_PID > /dev/null 2>&1; then
              echo "✅ 배포 성공!"
              echo "📋 서버 PID: $SERVER_PID"
              echo "📝 로그: tail -f /tmp/creditstory.log"
            else
              echo "❌ 배포 실패. 로그 확인:"
              tail -20 /tmp/creditstory.log
              exit 1
            fi 

            echo "✅ 순수 Node.js 배포 완료!"
