name: Deploy to Cafe24

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to Cafe24 Server
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.CAFE24_HOST }}
        username: ${{ secrets.CAFE24_USERNAME }}
        password: ${{ secrets.CAFE24_PASSWORD }}
        port: ${{ secrets.CAFE24_PORT }}
        script: |
          cd /home/hosting_users/${{ secrets.CAFE24_USERNAME }}/www
          echo "🚀 크레딧스토리 배포 시작..."
          
          # 모든 프로세스 정리
          echo "🔄 기존 프로세스 정리..."
          pkill -f "node" 2>/dev/null || true
          pkill -f "next" 2>/dev/null || true
          pkill -f "npm" 2>/dev/null || true
          pm2 kill 2>/dev/null || true
          
          # Docker 프로세스도 정리 (혹시 모르니)
          docker stop $(docker ps -q) 2>/dev/null || true
          docker rm $(docker ps -aq) 2>/dev/null || true
          
          # 최신 코드 업데이트
          echo "📥 코드 업데이트..."
          git pull origin main
          
          # Node.js 의존성 설치
          echo "📦 의존성 설치..."
          npm install
          
          # 애플리케이션 빌드
          echo "🏗️ 빌드..."
          npm run build
          
          # 환경 변수 설정
          echo "🔧 환경 변수 설정..."
          export NODE_ENV=production
          export PORT=3000
          export HOSTNAME=0.0.0.0
          
          # 서버 시작
          echo "🚀 서버 시작..."
          nohup npm start > app.log 2>&1 &
          
          # 잠시 대기 후 확인
          sleep 5
          
          # 프로세스 확인
          if pgrep -f "next" > /dev/null; then
            echo "✅ 배포 성공!"
            echo "📋 프로세스 ID: $(pgrep -f "next")"
          else
            echo "❌ 배포 실패. 로그:"
            tail -20 app.log
          fi 