name: Deploy to Cafe24

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci --production=false
        
      - name: Build Next.js
        run: npm run build
        env:
          NODE_ENV: production
          NEXT_PUBLIC_SUPABASE_URL: https://jwstrrxoyikjyafhaeyo.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3c3RycnhveWlranlhZmhhZXlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIxNTIzMzMsImV4cCI6MjA2NzcyODMzM30.ZpfX0zp5pJ_pstXjRkYNg85FoFEIP4qV3Js4nhTeFDU
          
      - name: Deploy built files to Cafe24
        uses: appleboy/ssh-action@v0.1.5
                with:
          host: ${{ secrets.CAFE24_HOST }}
          username: ${{ secrets.CAFE24_USERNAME }}
          password: ${{ secrets.CAFE24_PASSWORD }}
          port: ${{ secrets.CAFE24_PORT }}
          script: |
            echo "ğŸš€ ë¹Œë“œëœ íŒŒì¼ ë°°í¬ ì‹œì‘..."
            echo "ğŸ“‚ í˜„ì¬ ìœ„ì¹˜: $(pwd)"
            
            # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
            echo "ğŸ”„ ê¸°ì¡´ Node.js í”„ë¡œì„¸ìŠ¤ ì •ë¦¬..."
            pkill -f "node" 2>/dev/null || true
            pkill -f "next" 2>/dev/null || true
            pkill -f "npm" 2>/dev/null || true
            pm2 kill 2>/dev/null || true
            
            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ìƒì„±
            mkdir -p /home/${{ secrets.CAFE24_USERNAME }}/credit-app
            cd /home/${{ secrets.CAFE24_USERNAME }}/credit-app
            
            echo "âœ… ë°°í¬ ë””ë ‰í† ë¦¬ ì¤€ë¹„ ì™„ë£Œ: $(pwd)"
            
      - name: Copy built files to server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.CAFE24_HOST }}
          username: ${{ secrets.CAFE24_USERNAME }}
          password: ${{ secrets.CAFE24_PASSWORD }}
          port: ${{ secrets.CAFE24_PORT }}
          source: ".next,package.json,package-lock.json,public,next.config.ts"
          target: "/home/${{ secrets.CAFE24_USERNAME }}/credit-app/"
          
      - name: Start application
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.CAFE24_HOST }}
          username: ${{ secrets.CAFE24_USERNAME }}
          password: ${{ secrets.CAFE24_PASSWORD }}
          port: ${{ secrets.CAFE24_PORT }}
          script: |
            cd /home/${{ secrets.CAFE24_USERNAME }}/credit-app
            
            echo "ğŸ“¦ í”„ë¡œë•ì…˜ ì˜ì¡´ì„± ì„¤ì¹˜..."
            npm ci --production
            
            # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
            echo "ğŸ”§ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •..."
            export NODE_ENV=production
            export PORT=3000
            export HOSTNAME=0.0.0.0
            export NEXT_PUBLIC_SUPABASE_URL=https://jwstrrxoyikjyafhaeyo.supabase.co
            export NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3c3RycnhveWlranlhZmhhZXlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIxNTIzMzMsImV4cCI6MjA2NzcyODMzM30.ZpfX0zp5pJ_pstXjRkYNg85FoFEIP4qV3Js4nhTeFDU
            
            echo "âœ… í™˜ê²½ ë³€ìˆ˜ ì„¤ì • ì™„ë£Œ"
            
            # ì„œë²„ ì‹œì‘
            echo "ğŸš€ Next.js ì„œë²„ ì‹œì‘..."
            nohup npm start > /tmp/creditstory.log 2>&1 &
            SERVER_PID=$!
            echo $SERVER_PID > /tmp/creditstory.pid
            echo "ì„œë²„ PID: $SERVER_PID"
            
            # ì„œë²„ ì‹œì‘ í™•ì¸
            sleep 8
            if ps -p $SERVER_PID > /dev/null 2>&1; then
              echo "âœ… ë°°í¬ ì„±ê³µ!"
              echo "ğŸ“ ì„œë²„ ë¡œê·¸ (ë§ˆì§€ë§‰ 5ì¤„):"
              tail -5 /tmp/creditstory.log
            else
              echo "âŒ ì„œë²„ ì‹œì‘ ì‹¤íŒ¨. ë¡œê·¸:"
              cat /tmp/creditstory.log
              exit 1
            fi
            
            echo "ğŸ‰ ë°°í¬ ì™„ë£Œ!"
