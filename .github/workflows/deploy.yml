name: Deploy to Cafe24

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to Cafe24 Server
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.CAFE24_HOST }}
          username: ${{ secrets.CAFE24_USERNAME }}
          password: ${{ secrets.CAFE24_PASSWORD }}
          port: ${{ secrets.CAFE24_PORT }}
          debug: true
          script: |
            echo "ğŸ” ì„œë²„ í™˜ê²½ í™•ì¸ ì¤‘..."
            echo "ğŸ“‚ í˜„ì¬ ìœ„ì¹˜: $(pwd)"
            echo "ğŸ“‚ í™ˆ ë””ë ‰í† ë¦¬: $HOME"
            echo "ğŸ‘¤ í˜„ì¬ ì‚¬ìš©ì: $(whoami)"
            echo "ğŸ’» ìš´ì˜ì²´ì œ: $(uname -a)"
            
            echo ""
            echo "ğŸ“‹ ì„¤ì¹˜ëœ ë„êµ¬ í™•ì¸:"
            echo "  - Git: $(git --version 2>/dev/null || echo 'âŒ ì„¤ì¹˜ ì•ˆë¨')"
            echo "  - Node.js: $(node --version 2>/dev/null || echo 'âŒ ì„¤ì¹˜ ì•ˆë¨')"
            echo "  - npm: $(npm --version 2>/dev/null || echo 'âŒ ì„¤ì¹˜ ì•ˆë¨')"
            
            echo ""
            echo "ğŸ’¾ ë””ìŠ¤í¬ ê³µê°„ í™•ì¸:"
            df -h
            
            echo ""
            echo "ğŸ“ í˜„ì¬ ë””ë ‰í† ë¦¬ ë‚´ìš©:"
            ls -la
            
            echo ""
            echo "ğŸŒ ë„¤íŠ¸ì›Œí¬ ì—°ê²° í…ŒìŠ¤íŠ¸:"
            ping -c 2 github.com 2>/dev/null || echo "âŒ GitHub ì—°ê²° ì‹¤íŒ¨"
            
            echo ""
            echo "ğŸ”§ í•„ìˆ˜ ë„êµ¬ ì„¤ì¹˜ ì¤‘..."
            
            # Git ì„¤ì¹˜ í™•ì¸ ë° ì„¤ì¹˜
            if ! command -v git >/dev/null 2>&1; then
              echo "ğŸ“¥ Git ì„¤ì¹˜ ì¤‘..."
              # CentOS/RHEL ê³„ì—´
              if command -v yum >/dev/null 2>&1; then
                sudo yum install -y git
              # Ubuntu/Debian ê³„ì—´
              elif command -v apt >/dev/null 2>&1; then
                sudo apt update && sudo apt install -y git
              else
                echo "âŒ íŒ¨í‚¤ì§€ ê´€ë¦¬ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
              fi
            else
              echo "âœ… Git ì´ë¯¸ ì„¤ì¹˜ë¨: $(git --version)"
            fi
            
            # Node.js ì„¤ì¹˜ í™•ì¸ ë° ì„¤ì¹˜
            if ! command -v node >/dev/null 2>&1; then
              echo "ğŸ“¥ Node.js ì„¤ì¹˜ ì¤‘..."
              # NodeSource ì €ì¥ì†Œ ì¶”ê°€ ë° Node.js ì„¤ì¹˜
              curl -fsSL https://rpm.nodesource.com/setup_18.x | sudo bash - 2>/dev/null || \
              curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash - 2>/dev/null
              
              if command -v yum >/dev/null 2>&1; then
                sudo yum install -y nodejs
              elif command -v apt >/dev/null 2>&1; then
                sudo apt install -y nodejs
              fi
            else
              echo "âœ… Node.js ì´ë¯¸ ì„¤ì¹˜ë¨: $(node --version)"
            fi
            
            # ì„¤ì¹˜ í›„ ì¬í™•ì¸
            echo ""
            echo "âœ… ì„¤ì¹˜ ì™„ë£Œ í›„ í™•ì¸:"
            echo "  - Git: $(git --version 2>/dev/null || echo 'âŒ ì„¤ì¹˜ ì‹¤íŒ¨')"
            echo "  - Node.js: $(node --version 2>/dev/null || echo 'âŒ ì„¤ì¹˜ ì‹¤íŒ¨')"
            echo "  - npm: $(npm --version 2>/dev/null || echo 'âŒ ì„¤ì¹˜ ì‹¤íŒ¨')"
            
            # í˜„ì¬ ìœ„ì¹˜ë¥¼ ì›¹ ë£¨íŠ¸ë¡œ ì‚¬ìš©
            WEB_ROOT=$(pwd)
            echo ""
            echo "âœ… ì›¹ ë£¨íŠ¸ ì„¤ì •: $WEB_ROOT"
            echo "ğŸš€ í¬ë ˆë”§ìŠ¤í† ë¦¬ ìˆœìˆ˜ Node.js ë°°í¬ ì‹œì‘..."
            echo "ğŸ“‚ ì‘ì—… ë””ë ‰í† ë¦¬: $(pwd)"

            # Node.js í”„ë¡œì„¸ìŠ¤ë§Œ ì •ë¦¬ (Docker ëª…ë ¹ì–´ ì™„ì „ ì œê±°)
            echo "ğŸ”„ ê¸°ì¡´ Node.js í”„ë¡œì„¸ìŠ¤ ì •ë¦¬..."
            pkill -f "node" 2>/dev/null || true
            pkill -f "next" 2>/dev/null || true
            pkill -f "npm" 2>/dev/null || true
            pm2 kill 2>/dev/null || true

            # ê¸°ì¡´ íŒŒì¼ ì™„ì „ ì‚­ì œ ë° ìƒˆ í”„ë¡œì íŠ¸ í´ë¡ 
            echo "ğŸ—‘ï¸ ê¸°ì¡´ íŒŒì¼ ì™„ì „ ì‚­ì œ..."
            rm -rf .git
            rm -rf *
            rm -rf .[^.]*
            echo "âœ… ê¸°ì¡´ íŒŒì¼ ì‚­ì œ ì™„ë£Œ"
            
            echo "ğŸ“¥ ìƒˆ í”„ë¡œì íŠ¸ í´ë¡ ..."
            if git clone https://github.com/yoonyeoul37/credit-recovery-community.git .; then
              echo "âœ… í”„ë¡œì íŠ¸ í´ë¡  ì™„ë£Œ"
            else
              echo "âŒ í”„ë¡œì íŠ¸ í´ë¡  ì‹¤íŒ¨"
              exit 1
            fi
            
            echo "ğŸ“‹ í´ë¡ ëœ íŒŒì¼ í™•ì¸:"
            ls -la

                        # Node.js ì˜ì¡´ì„± ì„¤ì¹˜
            echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜..."
            if npm ci --production=false; then
              echo "âœ… ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ"
            else
              echo "âŒ ì˜ì¡´ì„± ì„¤ì¹˜ ì‹¤íŒ¨"
              echo "Node.js ë²„ì „: $(node --version 2>/dev/null || echo 'ì—†ìŒ')"
              echo "npm ë²„ì „: $(npm --version 2>/dev/null || echo 'ì—†ìŒ')"
              exit 1
            fi
            
            # ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
            echo "ğŸ—ï¸ Next.js ë¹Œë“œ..."
            if npm run build; then
              echo "âœ… Next.js ë¹Œë“œ ì™„ë£Œ"
            else
              echo "âŒ Next.js ë¹Œë“œ ì‹¤íŒ¨"
              echo "ë¹Œë“œ ë¡œê·¸ í™•ì¸ ì¤‘..."
              exit 1
            fi

            # í™˜ê²½ ë³€ìˆ˜ ê°•ì œ ì„¤ì •
            echo "ğŸ”§ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •..."
            export NODE_ENV=production
            export PORT=3000
            export HOSTNAME=0.0.0.0

            # Supabase í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
            export NEXT_PUBLIC_SUPABASE_URL=https://jwstrrxoyikjyafhaeyo.supabase.co
            export NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3c3RycnhveWlranlhZmhhZXlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIxNTIzMzMsImV4cCI6MjA2NzcyODMzM30.ZpfX0zp5pJ_pstXjRkYNg85FoFEIP4qV3Js4nhTeFDU

            echo "âœ… í™˜ê²½ ë³€ìˆ˜ ì„¤ì • ì™„ë£Œ:"
            echo "   NODE_ENV: $NODE_ENV"
            echo "   PORT: $PORT"
            echo "   HOSTNAME: $HOSTNAME"

                        # ìˆœìˆ˜ Node.jsë¡œ ì„œë²„ ì‹œì‘ (Docker ì—†ìŒ)
            echo "ğŸš€ ìˆœìˆ˜ Node.js ì„œë²„ ì‹œì‘..."
            echo "ì„œë²„ ì‹œì‘ ì „ ìƒíƒœ:"
            echo "  - í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"
            echo "  - package.json ì¡´ì¬: $([ -f package.json ] && echo 'YES' || echo 'NO')"
            echo "  - .next í´ë” ì¡´ì¬: $([ -d .next ] && echo 'YES' || echo 'NO')"
            
            # ë¡œê·¸ íŒŒì¼ ì´ˆê¸°í™”
            > /tmp/creditstory.log
            
            # ì„œë²„ ì‹œì‘
            nohup npm start > /tmp/creditstory.log 2>&1 &
            SERVER_PID=$!
            echo "ì„œë²„ PID: $SERVER_PID"
            echo $SERVER_PID > /tmp/creditstory.pid
            
            # ì„œë²„ ì‹œì‘ í™•ì¸ (ë” ì˜¤ë˜ ê¸°ë‹¤ë¦¼)
            echo "ì„œë²„ ì‹œì‘ ëŒ€ê¸° ì¤‘... (10ì´ˆ)"
            sleep 10
            
            # í”„ë¡œì„¸ìŠ¤ í™•ì¸
            if ps -p $SERVER_PID > /dev/null 2>&1; then
              echo "âœ… ë°°í¬ ì„±ê³µ!"
              echo "ğŸ“‹ ì„œë²„ PID: $SERVER_PID"
              echo "ğŸ“ ìµœê·¼ ë¡œê·¸ (ë§ˆì§€ë§‰ 10ì¤„):"
              tail -10 /tmp/creditstory.log
            else
              echo "âŒ ì„œë²„ ì‹œì‘ ì‹¤íŒ¨. ì „ì²´ ë¡œê·¸ í™•ì¸:"
              cat /tmp/creditstory.log
              echo "í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ Node.js í”„ë¡œì„¸ìŠ¤:"
              ps aux | grep node | grep -v grep
              exit 1
            fi 

            echo "âœ… ìˆœìˆ˜ Node.js ë°°í¬ ì™„ë£Œ!"
