name: Deploy to Cafe24 Static

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build Next.js static site
        run: npm run build
        env:
          NODE_ENV: production
          NEXT_PUBLIC_SUPABASE_URL: https://jwstrrxoyikjyafhaeyo.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3c3RycnhveWlranlhZmhhZXlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIxNTIzMzMsImV4cCI6MjA2NzcyODMzM30.ZpfX0zp5pJ_pstXjRkYNg85FoFEIP4qV3Js4nhTeFDU
          
      - name: Create deployment package
        run: |
          echo "📦 정적 사이트 패키지 생성 중..."
          tar -czf static-site.tar.gz out/
          ls -la static-site.tar.gz
          ls -la out/
          
      - name: Upload static site to server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.CAFE24_HOST }}
          username: ${{ secrets.CAFE24_USERNAME }}
          password: ${{ secrets.CAFE24_PASSWORD }}
          port: ${{ secrets.CAFE24_PORT }}
          source: "static-site.tar.gz"
          target: "/tmp/"
          
      - name: Deploy static site
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.CAFE24_HOST }}
          username: ${{ secrets.CAFE24_USERNAME }}
          password: ${{ secrets.CAFE24_PASSWORD }}
          port: ${{ secrets.CAFE24_PORT }}
          timeout: 300s
          script: |
            echo "🚀 정적 사이트 배포 시작..."
            
            # 시스템 정보 확인
            echo "📊 시스템 정보:"
            whoami
            pwd
            echo "홈 디렉토리: $HOME"
            
            # 웹 루트 디렉토리 찾기
            if [ -d "$HOME/public_html" ]; then
              WEB_ROOT="$HOME/public_html"
            elif [ -d "$HOME/www" ]; then
              WEB_ROOT="$HOME/www"
            elif [ -d "$HOME/htdocs" ]; then
              WEB_ROOT="$HOME/htdocs"
            else
              WEB_ROOT="$HOME/public_html"
              mkdir -p "$WEB_ROOT"
            fi
            
            echo "웹 루트 디렉토리: $WEB_ROOT"
            
            # 기존 파일 백업
            if [ -f "$WEB_ROOT/index.html" ]; then
              echo "🔄 기존 사이트 백업..."
              mv "$WEB_ROOT" "$WEB_ROOT.backup.$(date +%Y%m%d_%H%M%S)" || true
              mkdir -p "$WEB_ROOT"
            fi
            
            # 정적 사이트 압축 해제
            echo "📦 정적 사이트 설치 중..."
            cd /tmp
            tar -xzf static-site.tar.gz
            
            # 파일 복사
            echo "📁 파일 복사 중..."
            cp -r out/* "$WEB_ROOT/"
            
            # 권한 설정
            chmod -R 755 "$WEB_ROOT"
            
            # 결과 확인
            echo "✅ 배포 완료!"
            echo "📁 웹 루트: $WEB_ROOT"
            echo "📄 파일 목록:"
            ls -la "$WEB_ROOT"
            echo "🌐 접속 주소: http://도메인/"
            echo "🎉 정적 사이트 배포 성공! Node.js 서버 없이 바로 접속 가능합니다."
            
            # 정리
            rm -f /tmp/static-site.tar.gz
            rm -rf /tmp/out
