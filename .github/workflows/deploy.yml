name: ì¹´í˜24 ìë™ ë°°í¬

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci
      
    - name: í”„ë¡œë•ì…˜ ë¹Œë“œ
      run: npm run build
      env:
        NODE_ENV: production
        NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
        NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
        
    - name: ë°°í¬ íŒ¨í‚¤ì§€ ìƒì„±
      run: |
        tar -czf deploy.tar.gz .next package.json package-lock.json public next.config.ts src tsconfig.json
        
    - name: ì„œë²„ì— íŒŒì¼ ì—…ë¡œë“œ
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.CAFE24_HOST }}
        username: ${{ secrets.CAFE24_USERNAME }}
        password: ${{ secrets.CAFE24_PASSWORD }}
        port: ${{ secrets.CAFE24_PORT }}
        source: "deploy.tar.gz"
        target: "/tmp/"
        
    - name: ì„œë²„ì—ì„œ ë°°í¬ ì‹¤í–‰
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.CAFE24_HOST }}
        username: ${{ secrets.CAFE24_USERNAME }}
        password: ${{ secrets.CAFE24_PASSWORD }}
        port: ${{ secrets.CAFE24_PORT }}
        script: |
          echo "ğŸš€ ì¹´í˜24 ìë™ ë°°í¬ ì‹œì‘..."
          
          # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
          sudo pkill -9 -f "node" || true
          sudo pkill -9 -f "next" || true
          
          # ë°°í¬ ë””ë ‰í† ë¦¬ ì¤€ë¹„
          cd /var/www/html
          sudo rm -rf nextjs-app
          sudo mkdir -p nextjs-app
          cd nextjs-app
          
          # íŒŒì¼ ì••ì¶• í•´ì œ
          sudo tar -xzf /tmp/deploy.tar.gz
          
          # ì˜ì¡´ì„± ì„¤ì¹˜
          sudo npm install --production
          
          # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
          sudo tee .env.local > /dev/null <<EOF
          NODE_ENV=production
          PORT=80
          HOSTNAME=0.0.0.0
          NEXT_PUBLIC_SUPABASE_URL=${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          EOF
          
          # ì„œë²„ ì‹œì‘
          sudo nohup npm start > ~/credit-app.log 2>&1 &
          
          # í™•ì¸
          sleep 5
          ps aux | grep next
          
          echo "âœ… ë°°í¬ ì™„ë£Œ!"
