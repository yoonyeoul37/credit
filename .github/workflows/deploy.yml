name: Complete Site Replacement

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build Next.js
        run: npm run build
        env:
          NODE_ENV: production
          NEXT_PUBLIC_SUPABASE_URL: https://jwstrrxoyikjyafhaeyo.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3c3RycnhveWlranlhZmhhZXlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIxNTIzMzMsImV4cCI6MjA2NzcyODMzM30.ZpfX0zp5pJ_pstXjRkYNg85FoFEIP4qV3Js4nhTeFDU
          
      - name: Create deployment package
        run: |
          echo "ğŸ“¦ ë°°í¬ íŒ¨í‚¤ì§€ ìƒì„±..."
          tar -czf deploy.tar.gz .next package.json package-lock.json public next.config.ts
          ls -la deploy.tar.gz
          
      - name: Upload deployment package
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.CAFE24_HOST }}
          username: ${{ secrets.CAFE24_USERNAME }}
          password: ${{ secrets.CAFE24_PASSWORD }}
          port: ${{ secrets.CAFE24_PORT }}
          source: "deploy.tar.gz"
          target: "/tmp/"
          
      - name: Complete site replacement
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.CAFE24_HOST }}
          username: ${{ secrets.CAFE24_USERNAME }}
          password: ${{ secrets.CAFE24_PASSWORD }}
          port: ${{ secrets.CAFE24_PORT }}
          timeout: 300s
          script: |
            echo "ğŸ”¥ ê¸°ì¡´ ì‚¬ì´íŠ¸ ì™„ì „ êµì²´ ì‹œì‘..."
            
            # 1. ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ëª¨ë‘ ì •ë¦¬
            echo "ğŸ›‘ ëª¨ë“  ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬..."
            pkill -f "node" || echo "Node.js í”„ë¡œì„¸ìŠ¤ ì—†ìŒ"
            pkill -f "npm" || echo "npm í”„ë¡œì„¸ìŠ¤ ì—†ìŒ"
            pkill -f "next" || echo "Next.js í”„ë¡œì„¸ìŠ¤ ì—†ìŒ"
            
            # 2. ê¸°ì¡´ ì›¹ íŒŒì¼ ë°±ì—…
            echo "ğŸ’¾ ê¸°ì¡´ ì‚¬ì´íŠ¸ ë°±ì—…..."
            BACKUP_DIR="$HOME/old-site-backup-$(date +%Y%m%d_%H%M%S)"
            
            if [ -d "$HOME/public_html" ]; then
              mv "$HOME/public_html" "$BACKUP_DIR"
              echo "âœ… public_html ë°±ì—… ì™„ë£Œ: $BACKUP_DIR"
            elif [ -d "$HOME/www" ]; then
              mv "$HOME/www" "$BACKUP_DIR"
              echo "âœ… www ë°±ì—… ì™„ë£Œ: $BACKUP_DIR"
            fi
            
            # 3. ìƒˆë¡œìš´ ì›¹ ë£¨íŠ¸ ìƒì„±
            echo "ğŸ†• ìƒˆë¡œìš´ ì›¹ ë£¨íŠ¸ ìƒì„±..."
            mkdir -p "$HOME/public_html"
            WEB_ROOT="$HOME/public_html"
            
            # 4. Next.js ì•± ë°°í¬
            echo "ğŸš€ Next.js ì•± ë°°í¬..."
            APP_DIR="$HOME/credit-app"
            mkdir -p "$APP_DIR"
            cd "$APP_DIR"
            
            # íŒŒì¼ ì••ì¶• í•´ì œ
            tar -xzf /tmp/deploy.tar.gz
            
            # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
            cat > .env.local << 'EOF'
            NODE_ENV=production
            PORT=80
            HOSTNAME=0.0.0.0
            NEXT_PUBLIC_SUPABASE_URL=https://jwstrrxoyikjyafhaeyo.supabase.co
            NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3c3RycnhveWlranlhZmhhZXlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIxNTIzMzMsImV4cCI6MjA2NzcyODMzM30.ZpfX0zp5pJ_pstXjRkYNg85FoFEIP4qV3Js4nhTeFDU
            EOF
            
            # ì˜ì¡´ì„± ì„¤ì¹˜
            echo "ğŸ“‹ ì˜ì¡´ì„± ì„¤ì¹˜..."
            npm ci --production --silent
            
            # 5. í¬íŠ¸ 80ì—ì„œ Next.js ì„œë²„ ì‹œì‘ ì‹œë„
            echo "ğŸ¯ í¬íŠ¸ 80ì—ì„œ ì„œë²„ ì‹œì‘ ì‹œë„..."
            sudo -u $USER nohup npm start > /tmp/credit-app.log 2>&1 &
            sleep 5
            
            # 6. ì„œë²„ ìƒíƒœ í™•ì¸
            if pgrep -f "node.*80" > /dev/null; then
              echo "âœ… í¬íŠ¸ 80ì—ì„œ ì„œë²„ ì‹œì‘ ì„±ê³µ!"
              echo "ğŸŒ ì ‘ì† ì£¼ì†Œ: http://ë„ë©”ì¸/ (í¬íŠ¸ 80)"
            else
              echo "âš ï¸ í¬íŠ¸ 80 ì‹¤íŒ¨, í¬íŠ¸ 8080ìœ¼ë¡œ ì¬ì‹œë„..."
              
              # í¬íŠ¸ 8080ìœ¼ë¡œ ì¬ì‹œë„
              sed -i 's/PORT=80/PORT=8080/' .env.local
              pkill -f "node" || true
              nohup npm start > /tmp/credit-app.log 2>&1 &
              sleep 5
              
              if pgrep -f "node.*8080" > /dev/null; then
                echo "âœ… í¬íŠ¸ 8080ì—ì„œ ì„œë²„ ì‹œì‘ ì„±ê³µ!"
                echo "ğŸŒ ì ‘ì† ì£¼ì†Œ: http://ë„ë©”ì¸:8080"
                
                # í¬íŠ¸ 8080 ë¦¬ë‹¤ì´ë ‰íŠ¸ í˜ì´ì§€ ìƒì„±
                cat > "$WEB_ROOT/index.html" << 'HTMLEOF'
                <!DOCTYPE html>
                <html>
                <head>
                  <meta charset="UTF-8">
                  <title>ì‹ ìš©íšŒë³µ ì»¤ë®¤ë‹ˆí‹°</title>
                  <meta http-equiv="refresh" content="1; url=:8080">
                  <script>
                    setTimeout(() => {
                      window.location.href = window.location.protocol + '//' + window.location.hostname + ':8080';
                    }, 1000);
                  </script>
                </head>
                <body style="font-family: Arial, sans-serif; text-align: center; padding: 50px;">
                  <h1>ğŸš€ ì‹ ìš©íšŒë³µ ì»¤ë®¤ë‹ˆí‹°</h1>
                  <p>ìƒˆë¡œìš´ ì‚¬ì´íŠ¸ë¡œ ì´ë™ ì¤‘ì…ë‹ˆë‹¤...</p>
                  <p><a href=":8080" style="color: #007bff;">ë°”ë¡œ ì´ë™í•˜ê¸°</a></p>
                </body>
                </html>
                HTMLEOF
              else
                echo "âŒ ì„œë²„ ì‹œì‘ ì™„ì „ ì‹¤íŒ¨"
                echo "ğŸ“ ë¡œê·¸:"
                cat /tmp/credit-app.log
                exit 1
              fi
            fi
            
            echo "ğŸ‰ ì‚¬ì´íŠ¸ êµì²´ ì™„ë£Œ!"
            echo "ğŸ“ ì„œë²„ ë¡œê·¸:"
            tail -5 /tmp/credit-app.log
            
            # ì •ë¦¬
            rm -f /tmp/deploy.tar.gz
