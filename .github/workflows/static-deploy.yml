name: 카페24 자동 배포

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: 코드 가져오기
      uses: actions/checkout@v4
      
    - name: Node.js 설정
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: 의존성 설치
      run: npm ci
      
    - name: 빌드
      run: npm run build
      env:
        NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
        NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
        
    - name: 서버 디렉토리 준비
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.CAFE24_HOST }}
        username: ${{ secrets.CAFE24_USERNAME }}
        password: ${{ secrets.CAFE24_PASSWORD }}
        port: ${{ secrets.CAFE24_PORT }}
        timeout: 180s
        script: |
          # 기존 프로세스 종료 (더 안전하게)
          pkill -f "npm start" 2>/dev/null || true
          pkill -f "next start" 2>/dev/null || true
          sleep 2
          
          # 현재 디렉토리 확인
          pwd
          whoami
          
          # 홈 디렉토리로 이동
          cd ~
          
          # 작업 디렉토리 생성 (더 안전한 경로)
          mkdir -p www
          cd www
          
          # 현재 위치 확인
          pwd
          echo "디렉토리 준비 완료"
          
    - name: 파일 업로드
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.CAFE24_HOST }}
        username: ${{ secrets.CAFE24_USERNAME }}
        password: ${{ secrets.CAFE24_PASSWORD }}
        port: ${{ secrets.CAFE24_PORT }}
        source: ".next,package.json,next.config.ts,src"
        target: "~/www/"
        timeout: 180s
        
    - name: 앱 실행
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.CAFE24_HOST }}
        username: ${{ secrets.CAFE24_USERNAME }}
        password: ${{ secrets.CAFE24_PASSWORD }}
        port: ${{ secrets.CAFE24_PORT }}
        timeout: 120s
        script: |
          cd ~/www
          echo "현재 디렉토리: $(pwd)"
          
          # 파일 확인
          ls -la
          
          npm install
          nohup npm start > app.log 2>&1 &
          
          # 3초 대기 후 프로세스 확인
          sleep 3
          if pgrep -f "next start"; then
            echo "✅ 배포 성공! 앱이 실행 중입니다."
          else
            echo "❌ 배포 실패! 로그 확인:"
            tail -20 app.log
          fi 