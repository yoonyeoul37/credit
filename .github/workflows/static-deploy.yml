name: SSH ê¸°ë°˜ ë°°í¬

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      uses: actions/checkout@v4
      
    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci --production
      
    - name: ë¹Œë“œ
      run: npm run build
      env:
        NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
        NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
        
    - name: ë°°í¬ íŒ¨í‚¤ì§€ ìƒì„±
      run: |
        mkdir -p deploy
        cp -r .next deploy/
        cp package.json deploy/
        cp package-lock.json deploy/
        cp next.config.ts deploy/
        cp -r public deploy/ 2>/dev/null || true
        cp -r src deploy/
        
    - name: ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
      run: |
        cat > deploy/deploy.sh << 'EOF'
        #!/bin/bash
        set -e
        
        echo "ğŸš€ ë°°í¬ ì‹œì‘..."
        
        # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
        echo "ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬..."
        pkill -f "next start" || true
        pkill -f "npm start" || true
        
        # ì˜ì¡´ì„± ì„¤ì¹˜
        echo "ì˜ì¡´ì„± ì„¤ì¹˜..."
        npm ci --production --no-audit
        
        # ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì•± ì‹œì‘
        echo "ì•± ì‹œì‘..."
        nohup npm start > app.log 2>&1 &
        
        # ì ì‹œ ëŒ€ê¸° í›„ í”„ë¡œì„¸ìŠ¤ í™•ì¸
        sleep 5
        if pgrep -f "next start"; then
          echo "âœ… ë°°í¬ ì„±ê³µ! ì•±ì´ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤."
          pgrep -f "next start"
        else
          echo "âŒ ë°°í¬ ì‹¤íŒ¨! ì•±ì´ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          tail -20 app.log
          exit 1
        fi
        EOF
        
        chmod +x deploy/deploy.sh
        
    - name: SSH ì—°ê²° í…ŒìŠ¤íŠ¸
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.CAFE24_HOST }}
        username: ${{ secrets.CAFE24_USERNAME }}
        password: ${{ secrets.CAFE24_PASSWORD }}
        port: ${{ secrets.CAFE24_PORT }}
        timeout: 60s
        script: |
          echo "SSH ì—°ê²° ì„±ê³µ!"
          whoami
          pwd
          ls -la
          
    - name: ì„œë²„ ë°°í¬
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.CAFE24_HOST }}
        username: ${{ secrets.CAFE24_USERNAME }}
        password: ${{ secrets.CAFE24_PASSWORD }}
        port: ${{ secrets.CAFE24_PORT }}
        timeout: 300s
        script: |
          echo "ì„œë²„ ë°°í¬ ì¤€ë¹„..."
          # ë°±ì—… ìƒì„±
          if [ -d "/home/creditstory-backup" ]; then
            rm -rf /home/creditstory-backup
          fi
          if [ -d "/home/creditstory" ]; then
            cp -r /home/creditstory /home/creditstory-backup
          fi
          
          # ìƒˆ ì•± ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p /home/creditstory
          
    - name: íŒŒì¼ ì—…ë¡œë“œ
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.CAFE24_HOST }}
        username: ${{ secrets.CAFE24_USERNAME }}
        password: ${{ secrets.CAFE24_PASSWORD }}
        port: ${{ secrets.CAFE24_PORT }}
        source: "deploy/*"
        target: "/home/creditstory/"
        strip_components: 1
        timeout: 300s
        
    - name: ì•± ì‹¤í–‰
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.CAFE24_HOST }}
        username: ${{ secrets.CAFE24_USERNAME }}
        password: ${{ secrets.CAFE24_PASSWORD }}
        port: ${{ secrets.CAFE24_PORT }}
        timeout: 300s
        script: |
          cd /home/creditstory
          echo "í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"
          echo "íŒŒì¼ ëª©ë¡:"
          ls -la
          echo "ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰..."
          chmod +x deploy.sh
          ./deploy.sh 