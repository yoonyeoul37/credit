name: í¬ë ˆë”§ìŠ¤í† ë¦¬ ìë™ ë°°í¬

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      uses: actions/checkout@v4
      
    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci
      
    - name: ë¹Œë“œ
      run: npm run build
      env:
        NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
        NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
        
    - name: ì„œë²„ ë°°í¬
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.CAFE24_HOST }}
        username: ${{ secrets.CAFE24_USERNAME }}
        password: ${{ secrets.CAFE24_PASSWORD }}
        port: ${{ secrets.CAFE24_PORT }}
        timeout: 300s
        script: |
          echo "ğŸš€ í¬ë ˆë”§ìŠ¤í† ë¦¬ ë°°í¬ ì‹œì‘"
          echo "ğŸ“… ë°°í¬ ì‹œê°„: $(date)"
          echo "ğŸŒ¿ ë°°í¬ ë¸Œëœì¹˜: ${{ github.ref }}"
          echo "ğŸ’¾ ì»¤ë°‹ í•´ì‹œ: ${{ github.sha }}"
          
          # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì•ˆì „í•˜ê²Œ ì¢…ë£Œ
          echo "ğŸ›‘ ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ"
          pm2 stop all 2>/dev/null || true
          pm2 delete all 2>/dev/null || true
          pkill -f "node" 2>/dev/null || true
          
          # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
          cd /var/www/html/credit
          
          # í˜„ì¬ ë¸Œëœì¹˜ í™•ì¸
          echo "ğŸ” í˜„ì¬ ë¸Œëœì¹˜: $(git branch --show-current)"
          echo "ğŸ” í˜„ì¬ ì»¤ë°‹: $(git rev-parse HEAD)"
          
          # ìµœì‹  ì½”ë“œ ì—…ë°ì´íŠ¸
          echo "ğŸ“¥ ìµœì‹  ì½”ë“œ ì—…ë°ì´íŠ¸"
          git fetch origin main
          git reset --hard origin/main
          
          # ìºì‹œ ì™„ì „ ì‚­ì œ
          echo "ğŸ§¹ ìºì‹œ ì‚­ì œ"
          rm -rf .next
          rm -rf node_modules
          
          # ì˜ì¡´ì„± ì„¤ì¹˜
          echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜"
          npm install
          
          # ë¹Œë“œ
          echo "ğŸ—ï¸ ë¹Œë“œ ì‹œì‘"
          npm run build
          echo "âœ… ë¹Œë“œ ì™„ë£Œ"
          
          # ë¹Œë“œ ê²°ê³¼ í™•ì¸
          if [ -d ".next" ]; then
            echo "âœ… .next í´ë” ìƒì„±ë¨"
            ls -la .next/
          else
            echo "âŒ .next í´ë”ê°€ ìƒì„±ë˜ì§€ ì•ŠìŒ"
            exit 1
          fi
          
          # PM2ë¡œ ì•± ì‹œì‘
          echo "ğŸš€ ì•± ì‹œì‘"
          NODE_ENV=production PORT=3000 pm2 start npm --name "creditstory" -- start
          pm2 save
          
          # ì ì‹œ ëŒ€ê¸°
          sleep 5
          
          # ìƒíƒœ í™•ì¸
          echo "ğŸ“Š ë°°í¬ ìƒíƒœ í™•ì¸"
          pm2 list
          pm2 logs creditstory --lines 10
          
          # í—¬ìŠ¤ì²´í¬
          echo "ğŸ” í—¬ìŠ¤ì²´í¬"
          curl -I http://localhost:3000/ || echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
          
          echo "âœ… ë°°í¬ ì™„ë£Œ!"
          echo "ğŸ‰ ë°°í¬ ì„±ê³µ: $(date)"
          
    - name: íŒŒì¼ ì—…ë¡œë“œ
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.CAFE24_HOST }}
        username: ${{ secrets.CAFE24_USERNAME }}
        password: ${{ secrets.CAFE24_PASSWORD }}
        port: ${{ secrets.CAFE24_PORT }}
        source: ".next,package.json,package-lock.json"
        target: "/var/www/html/credit/"
        timeout: 300s
