name: Static Site Deploy

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build static site
        run: npm run export
        env:
          NODE_ENV: production
          NEXT_PUBLIC_SUPABASE_URL: https://jwstrrxoyikjyafhaeyo.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3c3RycnhveWlranlhZmhhZXlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIxNTIzMzMsImV4cCI6MjA2NzcyODMzM30.ZpfX0zp5pJ_pstXjRkYNg85FoFEIP4qV3Js4nhTeFDU
          
      - name: Create static deployment package
        run: |
          echo "ğŸ“¦ ì •ì  ì‚¬ì´íŠ¸ íŒ¨í‚¤ì§€ ìƒì„±..."
          cd out
          tar -czf ../static-site.tar.gz .
          cd ..
          ls -la static-site.tar.gz
          echo "ğŸ“ ì •ì  íŒŒì¼ ë‚´ìš© í™•ì¸:"
          ls -la out/ | head -10
          
      - name: Upload static site
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.CAFE24_HOST }}
          username: ${{ secrets.CAFE24_USERNAME }}
          password: ${{ secrets.CAFE24_PASSWORD }}
          port: ${{ secrets.CAFE24_PORT }}
          source: "static-site.tar.gz"
          target: "/tmp/"
          
      - name: Deploy static site
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.CAFE24_HOST }}
          username: ${{ secrets.CAFE24_USERNAME }}
          password: ${{ secrets.CAFE24_PASSWORD }}
          port: ${{ secrets.CAFE24_PORT }}
          timeout: 300s
          script: |
            echo "ğŸš€ ì •ì  ì‚¬ì´íŠ¸ ë°°í¬ ì‹œì‘..."
            
            # ê¸°ì¡´ Node.js í”„ë¡œì„¸ìŠ¤ ì™„ì „ ì •ë¦¬
            echo "ğŸ›‘ ëª¨ë“  Node.js í”„ë¡œì„¸ìŠ¤ ì •ë¦¬..."
            pkill -f "node" || echo "Node.js í”„ë¡œì„¸ìŠ¤ ì—†ìŒ"
            pkill -f "npm" || echo "npm í”„ë¡œì„¸ìŠ¤ ì—†ìŒ"
            pkill -f "next" || echo "Next.js í”„ë¡œì„¸ìŠ¤ ì—†ìŒ"
            
            # ê¸°ì¡´ ì›¹ íŒŒì¼ ë°±ì—…
            echo "ğŸ’¾ ê¸°ì¡´ ì‚¬ì´íŠ¸ ë°±ì—…..."
            BACKUP_DIR="$HOME/old-site-backup-$(date +%Y%m%d_%H%M%S)"
            
            if [ -d "$HOME/public_html" ]; then
              mv "$HOME/public_html" "$BACKUP_DIR"
              echo "âœ… public_html ë°±ì—… ì™„ë£Œ: $BACKUP_DIR"
            elif [ -d "$HOME/www" ]; then
              mv "$HOME/www" "$BACKUP_DIR"
              echo "âœ… www ë°±ì—… ì™„ë£Œ: $BACKUP_DIR"
            fi
            
            # ìƒˆë¡œìš´ ì›¹ ë£¨íŠ¸ ìƒì„±
            echo "ğŸ†• ìƒˆë¡œìš´ ì›¹ ë£¨íŠ¸ ìƒì„±..."
            mkdir -p "$HOME/public_html"
            WEB_ROOT="$HOME/public_html"
            
            # ì •ì  íŒŒì¼ ë°°í¬
            echo "ğŸ“ ì •ì  íŒŒì¼ ë°°í¬..."
            cd "$WEB_ROOT"
            tar -xzf /tmp/static-site.tar.gz
            
            echo "ğŸ“‹ ë°°í¬ëœ íŒŒì¼ í™•ì¸:"
            ls -la | head -20
            
            # index.html í™•ì¸
            if [ -f "index.html" ]; then
              echo "âœ… index.html íŒŒì¼ í™•ì¸ë¨"
              echo "ğŸ“„ index.html íŒŒì¼ í¬ê¸°: $(wc -c < index.html) bytes"
              echo "ğŸ“„ index.html ì•ë¶€ë¶„ ë¯¸ë¦¬ë³´ê¸°:"
              head -10 index.html
            else
              echo "âŒ index.html íŒŒì¼ ì—†ìŒ"
              echo "ğŸ“ í˜„ì¬ ë””ë ‰í† ë¦¬ íŒŒì¼ ëª©ë¡:"
              find . -name "*.html" | head -10
            fi
            
            # ê¶Œí•œ ì„¤ì •
            echo "ğŸ” íŒŒì¼ ê¶Œí•œ ì„¤ì •..."
            chmod -R 755 .
            
            # ë„ë©”ì¸ë³„ ë¦¬ë‹¤ì´ë ‰íŠ¸ í˜ì´ì§€ëŠ” ì œê±° (ì •ì  ì‚¬ì´íŠ¸ì´ë¯€ë¡œ ë¶ˆí•„ìš”)
            
            echo "ğŸ‰ ì •ì  ì‚¬ì´íŠ¸ ë°°í¬ ì™„ë£Œ!"
            echo "ğŸ“Š ë°°í¬ ì •ë³´:"
            echo "  ğŸ“ ì´ íŒŒì¼ ê°œìˆ˜: $(find . -type f | wc -l)"
            echo "  ğŸ“„ HTML íŒŒì¼ ê°œìˆ˜: $(find . -name "*.html" | wc -l)"
            echo "  ğŸ¨ CSS íŒŒì¼ ê°œìˆ˜: $(find . -name "*.css" | wc -l)"
            echo "  âš¡ JS íŒŒì¼ ê°œìˆ˜: $(find . -name "*.js" | wc -l)"
            echo "  ğŸ“Š ì´ í¬ê¸°: $(du -sh . | cut -f1)"
            
            echo "ğŸŒ ì ‘ì† ì£¼ì†Œ: http://ë„ë©”ì¸/"
            echo "âœ… ì •ì  ì‚¬ì´íŠ¸ ë°°í¬ ì„±ê³µ! Node.js ì„œë²„ ë¶ˆí•„ìš”!"
            
            # ì •ë¦¬
            rm -f /tmp/static-site.tar.gz 