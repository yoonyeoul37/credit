name: ì¹´í˜24 ìë™ ë°°í¬

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      uses: actions/checkout@v4
      
    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci
      
    - name: ë¹Œë“œ
      run: npm run build
      env:
        NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
        NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
        
    - name: ì„œë²„ ë””ë ‰í† ë¦¬ ì¤€ë¹„ ë° ì•± ì¤‘ì§€
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.CAFE24_HOST }}
        username: ${{ secrets.CAFE24_USERNAME }}
        password: ${{ secrets.CAFE24_PASSWORD }}
        port: ${{ secrets.CAFE24_PORT }}
        timeout: 300s
        script: |
          echo "ğŸ“¦ ê¸°ì¡´ ì•± ì¤‘ì§€ ë° ë””ë ‰í† ë¦¬ ì¤€ë¹„"
          which pm2 || npm install -g pm2

          # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ê°•ë ¥ ì¢…ë£Œ
          pm2 delete all || true
          pm2 kill || true
          pkill -f "npm start" 2>/dev/null || true
          pkill -f "next start" 2>/dev/null || true
          pkill -f "node" 2>/dev/null || true
          
          # í¬íŠ¸ 3000 ì‚¬ìš© ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ ê°•ì œ ì¢…ë£Œ
          lsof -ti:3000 | xargs kill -9 2>/dev/null || true
          sleep 3

          cd ~
          mkdir -p www
          cd www
          echo "âœ… ë””ë ‰í† ë¦¬ ì¤€ë¹„ ì™„ë£Œ"
          
    - name: íŒŒì¼ ì—…ë¡œë“œ
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.CAFE24_HOST }}
        username: ${{ secrets.CAFE24_USERNAME }}
        password: ${{ secrets.CAFE24_PASSWORD }}
        port: ${{ secrets.CAFE24_PORT }}
        source: ".next,package.json,next.config.ts,public,src"
        target: "~/www/"
        timeout: 300s
        
    - name: ì•± ì‹¤í–‰
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.CAFE24_HOST }}
        username: ${{ secrets.CAFE24_USERNAME }}
        password: ${{ secrets.CAFE24_PASSWORD }}
        port: ${{ secrets.CAFE24_PORT }}
        timeout: 300s
        script: |
          echo "ğŸš€ ì•± ì‹¤í–‰ ì‹œì‘"
          cd ~/www
          
          # ì˜ì¡´ì„± ì„¤ì¹˜ (devDependencies í¬í•¨)
          npm install
          
          # íŒŒì¼ í™•ì¸
          echo "ğŸ“ ì—…ë¡œë“œëœ íŒŒì¼ ëª©ë¡:"
          ls -la
          
          # ê¸°ì¡´ ì›¹ì„œë²„ í”„ë¡œì„¸ìŠ¤ ì°¾ê¸° ë° ì¤‘ì§€ ì‹œë„
          echo "ğŸ” í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì›¹ì„œë²„ í™•ì¸:"
          ps aux | grep -E "(apache|nginx|httpd)" | grep -v grep || echo "ì›¹ì„œë²„ í”„ë¡œì„¸ìŠ¤ ì—†ìŒ"
          
          # í¬íŠ¸ 80 ì‚¬ìš© ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ í™•ì¸
          echo "ğŸ” í¬íŠ¸ 80 ì‚¬ìš© í”„ë¡œì„¸ìŠ¤:"
          lsof -i:80 || echo "í¬íŠ¸ 80 ì‚¬ìš© í”„ë¡œì„¸ìŠ¤ ì—†ìŒ"
          
          # PM2ë¡œ ì•± ì‹¤í–‰ (í¬íŠ¸ 3000 ì‚¬ìš©, ë‚˜ì¤‘ì— í”„ë¡ì‹œ ì„¤ì •)
          echo "ğŸš€ PM2ë¡œ ì•± ì‹œì‘..."
          NODE_ENV=production PORT=3000 pm2 start npm --name "credit-app" -- start
          pm2 save
          
          # ì•± ìƒíƒœ í™•ì¸
          sleep 5
          echo "ğŸ“Š PM2 í”„ë¡œì„¸ìŠ¤ ìƒíƒœ:"
          pm2 list
          pm2 logs credit-app --lines 10 || true
          
          # í¬íŠ¸ ìƒíƒœ ìµœì¢… í™•ì¸
          echo "ğŸ” í¬íŠ¸ 3000 ìƒíƒœ í™•ì¸:"  
          lsof -i:3000 || echo "í¬íŠ¸ 3000ì´ ì‚¬ìš©ë˜ì§€ ì•Šê³  ìˆìŠµë‹ˆë‹¤"
          echo "ğŸ” í¬íŠ¸ 80 ìƒíƒœ í™•ì¸:"
          lsof -i:80 || echo "í¬íŠ¸ 80ì´ ì‚¬ìš©ë˜ì§€ ì•Šê³  ìˆìŠµë‹ˆë‹¤"
          
          # ì•± ì—°ê²° í…ŒìŠ¤íŠ¸
          echo "ğŸŒ ì•± ì—°ê²° í…ŒìŠ¤íŠ¸:"
          curl -I http://localhost:3000 || echo "í¬íŠ¸ 3000 ì—°ê²° ì‹¤íŒ¨"
          
          # ì„œë²„ ì„¤ì • í™•ì¸
          echo "ğŸ“‹ ì„œë²„ í™˜ê²½ ì •ë³´:"
          whoami
          pwd
          which node
          node --version
